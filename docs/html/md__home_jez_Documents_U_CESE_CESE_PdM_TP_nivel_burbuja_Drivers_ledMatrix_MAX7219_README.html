<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nivel de Superficies Digital: Device Driver para Matrix de LEDs de 8x8 con controlador MAX7219</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Nivel de Superficies Digital
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Device Driver para Matrix de LEDs de 8x8 con controlador MAX7219 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Este <em>Device Driver</em> es un <b>Polled Driver</b> que permite configurar y controlar una matriz de LEDs de 8x8 que utiliza el controlador MAX7219.</p>
<p>El propósito de este driver es facilitar el renderizado de un buffer de pantalla previamente generado, en la matriz de LEDs a través de la interfaz SPI, de forma similar a como se trabajaría cualquier otro display gráfico de mayor complejidad.</p>
<p>El diseño sigue una <em>arquitectura modular por capas</em>, donde la capa superior o de alto nivel funciona como abstracción del hardware, presentando una interfaz más amigable hacia el usuario.</p>
<p>Este driver tiene el siguiente alcance y limitaciones:</p>
<ul>
<li>Está diseñado para manejar una sola matriz y no puede manejar múltiples matrices en cascada sin antes extender la lógica de transmisión SPI.</li>
<li>No admite operaciones de lectura, por lo que se compone únicamente de operaciones de escritura o comandos enviados a la matriz de LEDs para su control.</li>
<li>No permite renderización parcial del display.</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Estructura del driver</h1>
<div class="fragment"><div class="line">ledMatrix_MAX7219/</div>
<div class="line"> ├── Inc/</div>
<div class="line"> │ ├── ledMatrix.h      # Interfaz de alto nivel del driver</div>
<div class="line"> │ └── ledMatrix_port.h # Interfaz de bajo nivel (acceso al hardware)</div>
<div class="line"> ├── Src/</div>
<div class="line"> │ ├── ledMatrix.c      # Implementación de funciones de alto nivel</div>
<div class="line"> │ └── ledMatrix_port.c # Implementación de funciones específicas del hardware y comunicación por SPI</div>
<div class="line"> └── docs/              # Documentación sobre el driver</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md18"></a>
Interfaz de alto nivel</h1>
<p>Las funciones y estructuras disponibles para el usuario están definidas en <code><a class="el" href="ledMatrix_8h.html" title="Device Driver para matriz de LEDs de 8x8 con controlador MAX7219.">ledMatrix.h</a></code>.</p>
<p>Entre las funcionalidades presentadas mediante la interfaz al usuario se encuentran:</p><ul>
<li>Inicializar el controlador MAX7219 para trabajar con la matriz de LEDs.</li>
<li>Setear la intensidad de los LEDs de forma simple con 3 niveles predefinidos.</li>
<li>Activar y desactivar el modo SHUTDOWN de la matriz.</li>
<li>Limpiar el display (apagar todos los LEDs).</li>
<li>Renderizar un buffer de pantalla en el display de LEDs.</li>
</ul>
<p>Este módulo utiliza una estructura <code><a class="el" href="structledMatrix__t.html">ledMatrix_t</a></code> que encapsula los datos necesarios para operar la matriz: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>{</div>
<div class="line">   GPIO_TypeDef * csPort;</div>
<div class="line">   uint16_t csPin;</div>
<div class="line">   SPI_HandleTypeDef * hSpi;</div>
<div class="line">} <a class="code" href="structledMatrix__t.html">ledMatrix_t</a>;</div>
<div class="ttc" id="astructledMatrix__t_html"><div class="ttname"><a href="structledMatrix__t.html">ledMatrix_t</a></div><div class="ttdef"><b>Definition:</b> ledMatrix.h:24</div></div>
</div><!-- fragment --><p> Esta estructura permite definir con claridad qué SPI usar y qué pin se utilizará como <b>CS (chip select)</b> para habilitar el dispositivo.</p>
<p>Las funciones disponibles son las siguientes:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Función   </th><th class="markdownTableHeadNone">Descripción    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ledMatrix_8h.html#a859f806de684566e40531672eb496318" title="Inicializador de la matriz a controlar.">ledMatrixInit()</a>   </td><td class="markdownTableBodyNone">Inicializa la matriz configurando el MAX7219    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="ledMatrix_8h.html#a56ef5508f90ff7f862222cd3ae1c01f8" title="Habilita o deshabilita el modo SHUTDOWN de la matriz.">ledMatrixShutdown()</a>   </td><td class="markdownTableBodyNone">Habilita o deshabilita el modo SHUTDOWN    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ledMatrix_8h.html#a7b6d978ae7ef048073481453dc8ec0ec" title="Limpia la matriz (apaga todos los leds).">ledMatrixClear()</a>   </td><td class="markdownTableBodyNone">Limpia el display (apagando todos los LEDs)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="ledMatrix_8h.html#a9a7287ffaabdebd914292cb71f35d5d4" title="Renderiza en la matriz la información del buffer de pantalla.">ledMatrixRender()</a>   </td><td class="markdownTableBodyNone">Renderiza un buffer pantalla de 8 bytes sobre la matriz    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ledMatrix_8h.html#a5af38095b6d75c9a188214a37ed31b7f" title="Setea el nivel de intensidad o brillo de los LEDs de la matriz.">ledMatrixSetIntensity()</a>   </td><td class="markdownTableBodyNone">Ajusta el brillo de los LEDs de la matriz   </td></tr>
</table>
<p><b>NOTA:</b> La función <code><a class="el" href="ledMatrix_8h.html#a9a7287ffaabdebd914292cb71f35d5d4" title="Renderiza en la matriz la información del buffer de pantalla.">ledMatrixRender()</a></code> espera un puntero a un arreglo de 8 bytes, donde cada byte representa una columna del display.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Capa de acceso al Hardware</h1>
<p>La capa inferior o de bajo nivel de este driver concentra la comunicación con el hardware mediante el protocolo SPI, utilizando las funciones que provee la HAL de STM32. Entre las funcionalidades de la capa de bajo nivel se encuentran:</p>
<ul>
<li>Setear un pin determinado en HIGH o LOW (utilizado para activar la comunicación mediante el pin designado como Chip Select.</li>
<li>Enviar un comando o instrucción y su correspondiente valor por SPI.</li>
<li>Posibilidad de saber si el envío de la instrucción se realizó exitosamente o con errores, mediante el valor de retorno de la función.</li>
</ul>
<h1><a class="anchor" id="autotoc_md20"></a>
Ejemplo de uso básico</h1>
<p>Ejemplo de inicialización y renderizado: </p><div class="fragment"><div class="line"><a class="code" href="structledMatrix__t.html">ledMatrix_t</a> <a class="code" href="main_8c.html#ab6664a3a684cfa4b2818fe41ea26aa7b">myMatrix</a>;</div>
<div class="line">uint8_t displayBuffer[8] = {0x10,0x18,0x1C,0xFE,0xFE,0x1C,0x18,0x10}; <span class="comment">// Flecha hacia arriba</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="ledMatrix_8h.html#a859f806de684566e40531672eb496318">ledMatrixInit</a>(&amp;<a class="code" href="main_8c.html#ab6664a3a684cfa4b2818fe41ea26aa7b">myMatrix</a>, &amp;hspi2, GPIOB, GPIO_PIN_6);</div>
<div class="line"><a class="code" href="ledMatrix_8h.html#a5af38095b6d75c9a188214a37ed31b7f">ledMatrixSetIntensity</a>(&amp;<a class="code" href="main_8c.html#ab6664a3a684cfa4b2818fe41ea26aa7b">myMatrix</a>, <a class="code" href="ledMatrix_8h.html#a289f5d26af6c61d56ccb47a2785c89fead07ebc0eee4eb4af5532ea456eb5101c">INTENSITY_MEDIUM</a>);</div>
<div class="line"><a class="code" href="ledMatrix_8h.html#a9a7287ffaabdebd914292cb71f35d5d4">ledMatrixRender</a>(&amp;<a class="code" href="main_8c.html#ab6664a3a684cfa4b2818fe41ea26aa7b">myMatrix</a>, displayBuffer);</div>
<div class="ttc" id="aledMatrix_8h_html_a289f5d26af6c61d56ccb47a2785c89fead07ebc0eee4eb4af5532ea456eb5101c"><div class="ttname"><a href="ledMatrix_8h.html#a289f5d26af6c61d56ccb47a2785c89fead07ebc0eee4eb4af5532ea456eb5101c">INTENSITY_MEDIUM</a></div><div class="ttdeci">@ INTENSITY_MEDIUM</div><div class="ttdef"><b>Definition:</b> ledMatrix.h:36</div></div>
<div class="ttc" id="aledMatrix_8h_html_a5af38095b6d75c9a188214a37ed31b7f"><div class="ttname"><a href="ledMatrix_8h.html#a5af38095b6d75c9a188214a37ed31b7f">ledMatrixSetIntensity</a></div><div class="ttdeci">matrixStatus_t ledMatrixSetIntensity(ledMatrix_t *ledMatrix, ledIntensity_t intensity)</div><div class="ttdoc">Setea el nivel de intensidad o brillo de los LEDs de la matriz.</div><div class="ttdef"><b>Definition:</b> ledMatrix.c:85</div></div>
<div class="ttc" id="aledMatrix_8h_html_a859f806de684566e40531672eb496318"><div class="ttname"><a href="ledMatrix_8h.html#a859f806de684566e40531672eb496318">ledMatrixInit</a></div><div class="ttdeci">matrixStatus_t ledMatrixInit(ledMatrix_t *ledMatrix, SPI_HandleTypeDef *hSpi, GPIO_TypeDef *csPort, uint16_t csPin)</div><div class="ttdoc">Inicializador de la matriz a controlar.</div><div class="ttdef"><b>Definition:</b> ledMatrix.c:29</div></div>
<div class="ttc" id="aledMatrix_8h_html_a9a7287ffaabdebd914292cb71f35d5d4"><div class="ttname"><a href="ledMatrix_8h.html#a9a7287ffaabdebd914292cb71f35d5d4">ledMatrixRender</a></div><div class="ttdeci">matrixStatus_t ledMatrixRender(ledMatrix_t *ledMatrix, const uint8_t *screen)</div><div class="ttdoc">Renderiza en la matriz la información del buffer de pantalla.</div><div class="ttdef"><b>Definition:</b> ledMatrix.c:74</div></div>
<div class="ttc" id="amain_8c_html_ab6664a3a684cfa4b2818fe41ea26aa7b"><div class="ttname"><a href="main_8c.html#ab6664a3a684cfa4b2818fe41ea26aa7b">myMatrix</a></div><div class="ttdeci">ledMatrix_t myMatrix</div><div class="ttdef"><b>Definition:</b> main.c:68</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md21"></a>
Información general sobre la Matriz de LEDs de 8x8 con controlador MAX7219.</h1>
<p><a href="./docs/max7219-max7221.pdf">Datasheet del controlador MAX7219</a></p>
<p>Esquema de conexión del módulo:</p>
<p><img src="./docs/max7219-dot-matrix-circuit-schematic.png" alt="" class="inline"/></p>
<p>El MAX7219 es un circuito integrado diseñado para el control de displays de LEDs, permitiendo gestionar hasta 64 LEDs mediante una interfaz serial compatible con SPI. Su arquitectura le permite operar con distintos tipos de arreglos, como matrices de LEDs de 8x8, displays de 7 segmentos de hasta 8 dígitos (originalmente diseñado para este fin) u otras configuraciones basadas en LEDs.</p>
<p>Este circuito integrado posee algunas características de utilidad como el control de la intensidad del display, un modo para testear el funcionamiento de los LEDs, un decodificador para BCD (Binary Coded Decimal), salidas compatibles para conexión en formato Daisy-Chain, y una pequeña memoria RAM interna con 8 registros de 8 bits donde guarda la información de cada dígito o grupo de 8 LEDs (filas o columnas) de la matriz.</p>
<p>Este integrado funciona como un multiplexor de filas o columnas de la matrix (según su conexión y orientanción). El esquematico de conexión es el siguiente: [](./docs/max7219-dot-matrix-circuit-schematic.png)</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Registros e Instrucciones</h2>
<p>El MAX7219 tiene un conjunto de registros de dígitos y de control a los que se les puede enviar comandos a través de la interfaz SPI. Cada comando se envía con 16 bits:</p><ul>
<li>Los primeros 8 bits (D15-D8) representan la dirección del registro que se desea escribir.</li>
<li>Los siguientes 8 bits (D7-D0) contienen el dato a escribir en ese registro.</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Nombre del Registro   </th><th class="markdownTableHeadNone">Dirección (Hexa)   </th><th class="markdownTableHeadNone">Descripción    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">No-op   </td><td class="markdownTableBodyNone">0xX0   </td><td class="markdownTableBodyNone">Utilizado para manejar múltiples drivers en daisy-chain. El comando No-op (0xX0) seguido de cualquier valor (0xXX) permite no enviar ningún cambio al driver.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Dígitos 0 a 7   </td><td class="markdownTableBodyNone">0xX1 a 0xX8   </td><td class="markdownTableBodyNone">Registros en RAM para programar los dígitos.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Modo de decodificación   </td><td class="markdownTableBodyNone">0xX9   </td><td class="markdownTableBodyNone">Habilita el modo de decodificación BCD para cada dígito. Cada bit de dato enviado a este registro corresponde a un dígito.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Intensidad del display   </td><td class="markdownTableBodyNone">0xXA   </td><td class="markdownTableBodyNone">Ajusta el brillo de los LEDs mediante un PWM interno en 16 niveles (0xX0 a 0xXF).    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Límite de dígitos a escanear   </td><td class="markdownTableBodyNone">0xXB   </td><td class="markdownTableBodyNone">Setea el número de dígitos a mostrar de 1 a 8 (0xX0 a 0xX7).    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Shutdown   </td><td class="markdownTableBodyNone">0xXC   </td><td class="markdownTableBodyNone">Controla el encendido/apagado del chip (0x00 = OFF, 0x01 = ON). Cuando el IC está en modo Shutdown ahorrará energía, pero aún puede ser programado.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Test de Display   </td><td class="markdownTableBodyNone">0xXF   </td><td class="markdownTableBodyNone">Operación en modo Test (todos los LEDs encendidos) o modo normal.   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
